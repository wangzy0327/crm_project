var MessageComm = MessageComm || {};
MessageComm.getSrcString = function (d, a) {
    var b = new RegExp("(^|&)" + a + "=([^&]*)(&|$)");
    var c = d.substr(d.indexOf("?") + 1).match(b);
    if (c != null) {
        return unescape(c[2])
    }
    return null
};
MessageComm.page = {
    m: 101000000, init: function (e, a, d, c, b) {
        this.ele = e;
        this.msgType = a;
        this.shareUrl = d;
        this.hasFrame = c || 0;
        this.isShowFooter = b || 0;
        this.createPageHtml();
        this.initHotLabel();
        this.handleTurnPage();
        this.handleAddPageLabel();
        this.handleDelPageLabel();
        this.handleHotLabel();
        this.handleTitleInput();
        this.handleSaveBtn();
        this.handlePushBtn()
    }, handleTurnPage: function () {
        var a = this;
        $("#pageWrap").on("click", ".prev", function () {
            if (a.hasFrame) {
                if ("function" === typeof frames["page-view"].prevPage) {
                    frames["page-view"].prevPage()
                }
            } else {
                if ("function" === typeof window.prevPage) {
                    window.prevPage()
                }
            }
        }).on("click", ".next", function () {
            if (a.hasFrame) {
                if ("function" === typeof frames["page-view"].nextPage) {
                    frames["page-view"].nextPage()
                }
            } else {
                if ("function" === typeof window.nextPage) {
                    window.nextPage()
                }
            }
        })
    }, handleAddPageLabel: function () {
        var a = this;
        $("#btn-label").click(function () {
            var b = $.trim($("#label-text").val());
            if (b) {
                a.createLabelHtml($("#label-view .box-label").length, -1, b);
                $("#label-text").val("")
            }
        });
        $("#label-list").on("click", ".label-add", function () {
            var c = $("#label-view .box-label").length, d = $(this).children(), e = d.data("id"), b = d.html();
            a.createLabelHtml(c, e, b)
        })
    }, handleDelPageLabel: function () {
        var a = this;
        $("#label-view").on("click", ".label-del", function () {
            $(this).remove();
            a.delPageLabel($(this).data("i"));
            $("#label-view .box-label").each(function (b, c) {
                $(c).attr("data-i", b)
            })
        })
    }, handleHotLabel: function () {
        $("#pageWrap .label-hot").mousemove(function () {
            $("#label-list").fadeIn(1000)
        });
        $("#label-list").mouseleave(function () {
            $(this).fadeOut(1000)
        })
    }, handleTitleInput: function () {
        var a = this;
        $("#title").blur(function () {
            var c = $(this).val(), b = a.hasFrame ? frames["page-view"].pageData : window.pageData;
            if (!c && !$.isEmptyObject(b)) {
                $(this).val(b.title || "")
            }
        })
    }, handleSaveBtn: function () {
        var a = this;
        $("#page-save").click(function () {
            if (!$(this).hasClass("btn_disabled")) {
                a.ajaxData(false, function (b) {
                    a.goBack("保存成功！")
                }, function (b) {
                    a.goBack("保存成功！")
                })
            }
        })
    }, handlePushBtn: function () {
        var a = this;
        $("#page-push").click(function () {
            if (!$(this).hasClass("btn_disabled")) {
                if (!module.service.validateData()) {
                    return false
                }
                $.dialog({
                    title: "选择人员",
                    parent: window.parent,
                    relative: 0,
                    content: "url:module/web/common/select-staff-two.html",
                    width: 600,
                    height: 450,
                    data: {
                        data: {
                            personIds: module.data.personIds,
                            personNames: module.data.personNames,
                            personCounts: module.data.personCounts
                        }, callback: function (c, b) {
                            $.confirm("您确定要推送吗？", function () {
                                c.api.close();
                                module.data.personIds = b.personIds;
                                module.data.personNames = b.personNames;
                                module.data.personCounts = b.personCounts;
                                a.ajaxData(true, function (d) {
                                    a.ajaxPush()
                                }, function (d) {
                                    a.ajaxPush()
                                })
                            })
                        }
                    }
                })
            }
        })
    }, initHotLabel: function () {
        var a = this, b = [{field: "corpid", value: YT.getCorpId(), operator: "=", relation: "and"}],
            c = {m: this.m, t: "v_message_tag_hot", filter: JSON.stringify(b), order: "count desc", r: 10};
        YT.query({
            data: c, successCallback: function (h) {
                if (200 == h.status) {
                    var d = h.object, f = "";
                    for (var e in d) {
                        var g = d[e];
                        f += a.createLabelHtml_add(g.tag_id, g.tag_name)
                    }
                    $("#label-list .box").append(f)
                } else {
                    $.alert("网络异常，请与管理员联系！")
                }
            }
        })
    }, createLabelHtml: function (b, c, a) {
        $("#label-view .box").append(this.createLabelHtml_del(b, c, a));
        this.addPageLabel(c, a)
    }, addPageLabel: function (c, b) {
        var a = this.hasFrame ? frames["page-view"].activeIndex : window.activeIndex;
        if (module.data.labelNames[a] == undefined) {
            module.data.labelNames[a] = []
        }
        module.data.labelNames[a].push({id: c, name: b})
    }, delPageLabel: function (b) {
        var a = this.hasFrame ? frames["page-view"].activeIndex : window.activeIndex;
        module.data.labelNames[a].splice(b, 1)
    }, ajaxData: function (d, k, e) {
        if (!module.service.validateData()) {
            return false
        }
        var f = module.data.messageData, l = JSON.parse($.cookie("userInfo")), g = module.service.getPostData(),
            c = {m: module.data.m, t: "message"},
            h = {slave_label: module.data.labelNames, corpid: l.corpid, msgType: this.msgType};
        if (5 == this.msgType) {
            h.pageUrl = g.description
        } else {
            if (6 == this.msgType) {
                var b = this.hasFrame ? frames["page-view"].pageData : window.pageData;
                if (!$.isEmptyObject(b)) {
                    h.imgUrl = b.imgUrl + b.size
                }
            }
        }
        if (!$.isEmptyObject(f)) {
            var j = f.id, a = [{field: "id", value: j, operator: "=", relation: "AND"}];
            g.id = j;
            var i = [{t: "message_tag_relation", key: "id:message_id"}];
            c.v = JSON.stringify([{t: "message", data: g, filter: a, id: j, slave: i}]);
            h.data_id = j;
            c.params = JSON.stringify(h);
            YT.update({
                data: c, successCallback: function (n) {
                    if (n.status == 200) {
                        var m = n.object;
                        if (6 == g.msgType) {
                            g.picurl = m.picurl
                        }
                        module.data.messageData = $.extend(f, g);
                        e(n)
                    } else {
                        $.alert("保存失败!")
                    }
                }
            })
        } else {
            g.msgType = this.msgType;
            g.type = 1;
            g.url = YT.server + this.shareUrl;
            g.btntxt = "阅读全文";
            g.corp_id = l.corp_id;
            g.suite_id = l.suite_id;
            g.app_id = l.app_id;
            g.corpid = l.corpid;
            g.createUserId = l.userId;
            g.createTime = new Date().Format("yyyy-MM-dd hh:mm:ss");
            if (d) {
                c.v = JSON.stringify([{t: "message", data: g, ai: true, slave: i}]);
                c.params = JSON.stringify(h);
                YT.insert({
                    data: c, successCallback: function (n) {
                        if (n.status == 200) {
                            var m = n.object;
                            g.id = m.ids[0];
                            if (6 == g.msgType) {
                                g.picurl = m.picurl
                            }
                            module.data.messageData = g;
                            k(n)
                        } else {
                            $.alert("保存失败!")
                        }
                    }
                })
            } else {
                $.dialog({
                    title: "选择组",
                    parent: window.parent,
                    relative: false,
                    content: "url:/module/web/message/select-groups.html",
                    width: 600,
                    height: 450,
                    data: {
                        callback: function (p, o) {
                            p.api.close();
                            var m = [];
                            for (var n in o) {
                                m.push({t: "groups_message_relation", data: {group_id: o[n]}, key: "message_id"})
                            }
                            c.v = JSON.stringify([{t: "message", data: g, ai: true, slave: m}]);
                            c.params = JSON.stringify(h);
                            YT.insert({
                                data: c, successCallback: function (r) {
                                    if (r.status == 200) {
                                        var q = r.object;
                                        g.id = q.ids[0];
                                        if (6 == g.msgType) {
                                            g.picurl = q.picurl
                                        }
                                        module.data.messageData = g;
                                        k(r)
                                    } else {
                                        $.alert("保存失败!")
                                    }
                                }
                            })
                        }
                    }
                })
            }
        }
    }, ajaxData_dialog: function () {
        if (!module.service.validateData()) {
            return false
        }
        var d = module.data.messageData, i = JSON.parse($.cookie("userInfo")), e = module.service.getPostData(),
            c = {m: module.data.m, t: "message"},
            f = {slave_label: module.data.labelNames, corpid: i.corpid, msgType: this.msgType};
        if (5 == this.msgType) {
            f.pageUrl = e.description
        } else {
            if (6 == this.msgType) {
                var b = this.hasFrame ? frames["page-view"].pageData : window.pageData;
                if (!$.isEmptyObject(b)) {
                    f.imgUrl = b.imgUrl + b.size
                }
            }
        }
        if (!$.isEmptyObject(d)) {
            var h = d.id, a = [{field: "id", value: h, operator: "=", relation: "AND"}];
            e.id = h;
            var g = [{t: "message_tag_relation", key: "id:message_id"}];
            c.v = JSON.stringify([{t: "message", data: e, filter: a, id: h, slave: g}]);
            f.data_id = h;
            c.params = JSON.stringify(f);
            YT.update({
                data: c, successCallback: function (j) {
                    if (j.status == 200) {
                        $.alert("保存成功!", function () {
                            callback(window)
                        })
                    } else {
                        $.alert("保存失败!")
                    }
                }
            })
        }
    }, ajaxPush: function () {
        var d = this, f = module.data.messageData, a = [], c = new Date().Format("yyyy-MM-dd hh:mm:ss");
        for (var e = 0; e < module.data.personIds.length; e++) {
            a.push({
                t: "message_share",
                data: {messageId: f.id, staffId: module.data.personIds[e], pushTime: c, shareFlag: 0, openCount: 0},
                ai: true
            })
        }
        var b = {
            m: module.data.m,
            t: "message_share",
            v: JSON.stringify(a),
            params: JSON.stringify({message_id: f.id, staff_ids: module.data.personIds.join(",")})
        };
        YT.insert({
            data: b, successCallback: function (h) {
                if (h.status == 200) {
                    var g = [];
                    if (a.length == 1) {
                        g.push(h.object)
                    } else {
                        g = h.object
                    }
                    d.pushMsg(g)
                } else {
                    $.alert("推送失败！")
                }
            }
        })
    }, pushMsg: function (c) {
        var a = JSON.parse($.cookie("userInfo")), d = module.data.messageData,
            f = {title: d.titleText, btntxt: "阅读全文", picurl: ""}, e = YT.getTicket();
        switch (+d.msgType) {
            case 2:
            case 6:
                f.picurl = YT.server + "/module/web/upload/" + d.picurl;
                break;
            case 5:
                break
        }
        for (var b = 0; b < module.data.personIds.length; b++) {
            if (e == null || e === undefined) {
                e = ""
            }
            f.url = d.url + "?tkt=" + e + "&u=" + module.data.personIds[b] + "&d=" + c[b] + "&s=0&t=0";
            pushMsgTool.sendMessage({
                config: {
                    toType: {type: [1], touser: module.data.personCounts[b]},
                    msgtype: "news",
                    safe: 0
                }, content: {articles: [f]}, userId: a.userId, appId: appAgent.apps.sales_ass_id
            }, function (g) {
            }, function (g) {
            })
        }
        this.goBack("已推送！")
    }, showDialog: function (a, b) {
        $.dialog({
            title: "提示",
            width: 350,
            height: 100,
            content: '<table class="alert"><tbody><tr><td class="alert-icon"><i class="iconfont"></i></td><td class="alert-content">' + a + "</td></tr></tbody></table>",
            buttons: [{
                name: "前往列表页", className: "btn-lightBlue", callback: function () {
                    b();
                    return false
                }
            }, {name: "留在当前页"}]
        })
    }, goBack: function (a) {
        $.alert(a, function () {
            location.href = YT.server + "/module/web/message/message-list.html?" + location.href.split("?")[1]
        })
    }, createPageHtml: function () {
        var a = "";
        a += '<div class="box" id="pageWrap" style="display: none;">';
        a += '<div class="page-left">';
        if (this.hasFrame) {
            a += '<iframe name="page-view" id="page-view"></iframe>'
        } else {
            a += '<div id="page-view"></div>'
        }
        a += "</div>";
        a += '<div class="page-center">';
        a += '<i class="iconfont f32 prev">&#xe60d;</i>';
        a += "</br></br>";
        a += '<i class="iconfont f32 next">&#xe60a;</i>';
        a += "</div>";
        a += '<div class="page-right">';
        a += '<div class="content-header">';
        a += '<div style="text-align: left;">';
        a += "<label>标题：</label>";
        a += '<input type="text" class="input" id="title" placeholder="请输入标题" maxlength="50">';
        a += "</div>";
        a += '<div class="fl">';
        a += '<input type="text" class="input" id="label-text" placeholder="请输入标签名称" maxlength="20">';
        a += '<a id="btn-label">添加</a>';
        a += "</div>";
        a += '<div class="fr">';
        a += '<img src="/image/hot.png" class="label-hot">';
        a += '<div id="label-list">';
        a += '<div class="box"></div>';
        a += "</div>";
        a += "</div>";
        a += "</div>";
        a += '<div class="clear"></div>';
        a += '<div id="label-view">';
        a += '<div class="box" style="max-height: 250px;"></div>';
        a += "</div>";
        if (this.isShowFooter) {
            a += '<div class="content-footer">';
            a += '<a type="button" class="btn" id="page-save" style="margin-right: 10px;">保存</a>';
            a += '<a type="button" class="btn" id="page-push">发布</a>';
            a += "</div>"
        }
        a += "</div>";
        a += "</div>";
        $(this.ele).append(a)
    }, createLabelHtml_add: function (c, a) {
        var b = "";
        b += '<div class="box-label label-add">';
        b += '<span name="label-name" data-id="' + c + '">' + a + "</span>";
        b += '<span class="label-hover label-hover-bg"></span>';
        b += '<span class="label-hover"><i class="iconfont icon-add">&#xe672;</i></span>';
        b += "</div>";
        return b
    }, createLabelHtml_del: function (c, d, a) {
        var b = "";
        b += '<div class="box-label label-del" data-i="' + c + '">';
        b += '<span data-id="' + d + '">' + a + "</span>";
        b += '<span class="label-hover label-hover-bg"></span>';
        b += '<span class="label-hover"><i class="iconfont icon-del">&#xe601;</i></span>';
        b += "</div>";
        return b
    }, initData: function (c) {
        var a = this, b = YT.getUrlParam("id");
        a.getLabelData(b, function (h) {
            var e = h;
            for (var f in e) {
                var j = e[f], d = --j.page, g = {id: j.tag_id, name: j.tag_name};
                if (module.data.labelNames[d]) {
                    module.data.labelNames[d].push(g)
                } else {
                    module.data.labelNames[d] = [g]
                }
            }
            a.getMessageData(b, function (i) {
                module.data.messageData = i;
                module.data.title = i.title;
                c(i)
            })
        })
    }, getMessageData: function (c, d) {
        var a = [{field: "id", value: c, operator: "=", relation: "and"}];
        var b = {m: module.data.m, t: "v_message", filter: JSON.stringify(a)};
        YT.query({
            data: b, successCallback: function (e) {
                if (200 == e.status) {
                    d(e.object[0])
                } else {
                    $.alert("网络异常，请与管理员联系！")
                }
            }
        })
    }, getLabelData: function (c, d) {
        var a = [{field: "message_id", value: YT.getUrlParam("id"), operator: "=", relation: "and"}];
        var b = {m: module.data.m, t: "v_message_tag", filter: JSON.stringify(a)};
        YT.query({
            data: b, successCallback: function (e) {
                if (200 == e.status) {
                    d(e.object)
                } else {
                    $.alert("网络异常，请与管理员联系！")
                }
            }
        })
    }, initPageWrapStatus: function (a, c) {
        var b = a || 320, e = c || 504, d;
        $("#pageWrap").show();
        if (this.hasFrame) {
            d = $('iframe[name="page-view"]');
            d.attr({"width": b + "px", "height": e + "px"})
        } else {
            d = $("#page-view");
            d.css({"width": b + "px", "height": e + "px"})
        }
        if (undefined != d) {
            d.addClass("page-view-bg")
        }
        $("#page-save, #page-push").addClass("btn_disabled")
    }, removePageWrapStatus: function () {
        var a;
        if (this.hasFrame) {
            a = $('iframe[name="page-view"]')
        } else {
            a = $("#page-view")
        }
        if (undefined != a) {
            a.removeClass("page-view-bg")
        }
        $("#page-save, #page-push").removeClass("btn_disabled")
    }
};
MessageComm.share = {
    m: 101000000, shareId: -1, shareDetailId: -1, share_link: "", initWxConfig: function (a) {
        wxCommon.service.initWxConfig(["onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareWeibo", "onMenuShareQZone", "showAllNonBaseMenuItem", "hideAllNonBaseMenuItem"], function () {
            a()
        }, function () {
            $.hideLoading()
        }, function () {
            $.hideLoading()
        }, function () {
            $.hideLoading()
        })
    }, _initWxConfig: function (a, b, c) {
        wxCommon.service.initWxConfig(["onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareWeibo", "onMenuShareQZone", "showAllNonBaseMenuItem", "hideAllNonBaseMenuItem"], function () {
            c()
        }, function () {
            if ("" + a == "0" && b == 1) {
                $.alert("加载失败，请刷新页面!", "提示", function () {
                    location.reload()
                })
            }
        }, function () {
            if ("" + a == "0" && b == 1) {
                $.alert("加载失败，请刷新页面!", "提示", function () {
                    location.reload()
                })
            }
        }, function () {
            if ("" + a == "0" && b == 1) {
                $.alert("加载失败，请刷新页面!", "提示", function () {
                    location.reload()
                })
            }
        })
    }, initWxShare: function (b, a) {
        wx.onMenuShareTimeline({
            title: b.share_title, link: b.share_link, imgUrl: b.share_imgurl, success: function () {
                if (b.onsuccess && a != null && a !== undefined) {
                    b.onsuccess("朋友圈")
                }
            }, cancel: function () {
            }
        });
        wx.onMenuShareAppMessage({
            title: b.share_title,
            desc: b.share_desc,
            link: b.share_link,
            imgUrl: b.share_imgurl,
            type: "",
            dataUrl: "",
            success: function () {
                if (b.onsuccess && a != null && a !== undefined) {
                    b.onsuccess("朋友")
                }
            },
            cancel: function () {
            }
        });
        wx.onMenuShareQQ({
            title: b.share_title,
            desc: b.share_desc,
            link: b.share_link,
            imgUrl: b.share_imgurl,
            success: function () {
                if (b.onsuccess && a != null && a !== undefined) {
                    b.onsuccess("QQ")
                }
            },
            cancel: function () {
            }
        });
        wx.onMenuShareWeibo({
            title: b.share_title,
            desc: b.share_desc,
            link: b.share_link,
            imgUrl: b.share_imgurl,
            success: function () {
                if (b.onsuccess && a != null && a !== undefined) {
                    b.onsuccess("微博")
                }
            },
            cancel: function () {
            }
        });
        wx.onMenuShareQZone({
            title: b.share_title,
            desc: b.share_desc,
            link: b.share_link,
            imgUrl: b.share_imgurl,
            success: function () {
                if (b.onsuccess && a != null && a !== undefined) {
                    b.onsuccess("空间")
                }
            },
            cancel: function () {
            }
        });
        wx.showAllNonBaseMenuItem()
    }, insertShare: function (h, b, g, e, c, a, f) {
        var d = this;
        this.shareId = g;
        this.shareDetailId = e;
        this.share_link = h.share_link;
        this.staff_id = f;
        this.ajaxData(a, function (i) {
            d.id = i;
            if (0 == b) {
                $(document.body).addClass("page-unScroll");
                $("#popup_customer").popup();
                $("#save, #toolbar-save").click(function () {
                    MessageComm.customer.triggerSaveBtn(d.id, f)
                })
            }
            h.share_link = c + "&uid=" + YT.uuid();
            MessageComm.share.initWxShare(h, b)
        })
    }, ajaxData: function (a, d) {
        var c = this, b = [];
        b.push({
            t: "message_share_uid",
            data: {
                shareId: c.shareId,
                shareDetailId: c.shareDetailId,
                uid: YT.getSrcString(c.share_link, "uid"),
                time: new Date().Format("yyyy-MM-dd hh:mm:ss")
            },
            ai: true
        });
        YT.insert({
            loading: false,
            data: {
                m: c.m,
                t: "message_share_uid",
                v: JSON.stringify(b),
                params: JSON.stringify({ip: a}),
                isvisitor: MessageComm.customer.isvisitor
            },
            successCallback: function (e) {
                d(e.object)
            }
        })
    }
};
MessageComm.customer = {
    m: 1010000,
    customerData: {},
    customerList: [],
    pager: {loading: false, lastPage: false, pageCount: 0, page: 1, rows: 15},
    searchPager: {loading: false, lastPage: false, pageCount: 0, page: 1, rows: 15},
    callback: function () {
    },
    init: function (b, a) {
        this.ele = b || "#btn-save";
        this.isvisitor = a || 0;
        this.createPopupHtml();
        this.initForm();
        this.handleSaveBtn();
        this.handleChooseBtn();
        this.handleClearBtn();
        this.handleCloseBtn();
        this.handleRefresh();
        this.handleInfinite();
        this.handleSearchInput();
        this.handleSearchCancel()
    },
    initForm: function () {
        var b = [{id: "mobile", name: "手机号", type: "number", p_name: "pattern", p_val: "[0-9]*"}, {
            id: "name",
            name: "姓名",
            type: "text",
            p_name: "maxlength",
            p_val: "8"
        }, {id: "wechat", name: "微信号", type: "text", p_name: "maxlength", p_val: "30"}, {
            id: "department",
            name: "公司",
            type: "text",
            p_name: "maxlength",
            p_val: "30"
        }, {id: "position", name: "职位", type: "text", p_name: "maxlength", p_val: "20"}, {
            id: "address",
            name: "地址",
            type: "text",
            p_name: "maxlength",
            p_val: "50"
        }, {id: "telephone", name: "座机", type: "text", p_name: "maxlength", p_val: "13"}, {
            id: "email",
            name: "邮箱",
            type: "text",
            p_name: "maxlength",
            p_val: "30"
        }, {id: "webSite", name: "网址", type: "text", p_name: "maxlength", p_val: "50"}, {
            id: "fax",
            name: "传真",
            type: "text",
            p_name: "maxlength",
            p_val: "30"
        }];
        var a = $("#form_customer");
        a.children().remove();
        a.append(this.createFormHtml(b))
    },
    triggerSaveBtn: function (b, a) {
        this.id = b;
        this.staff_id = a;
        $(this.ele).triggerHandler("click")
    },
    handleSaveBtn: function () {
        var a = this, b = $("#popup_choose");
        $(this.ele).click(function () {
            a.validateData()
        });
        b.on("click", ".close-popup_choose", function () {
            var c = b.find('.customer-list input[name="radio"]:checked');
            if (c.is(":checked")) {
                a.customerData = c.data("d");
                a.setCustomerVal(a.customerData);
                MessageComm.customer.triggerSaveBtn(MessageComm.share.id, MessageComm.share.staff_id)
            } else {
                a.customerData = {};
                a.setCustomerVal(a.customerData);
                $.alert("未选择客户！")
            }
        })
    },
    handleChooseBtn: function () {
        var a = this;
        $("#choose").click(function () {
            var b = $("#popup_choose");
            b.addClass("weui-popup__container--visible").css("display", "block");
            if (!a.pager.lastPage && a.customerList.length == 0) {
                a.initCustomerData(b)
            } else {
                a.createCustomerData(b, a.customerList)
            }
        })
    },
    handleClearBtn: function () {
        var a = this;
        $("#btn-clear").click(function () {
            a.resetCustomerData()
        })
    },
    handleCloseBtn: function () {
        var a = this;
        $("#popup_customer").on("click", ".close-popup_customer", function () {
            a.resetCustomerDom();
            a.resetCustomerData()
        });
        $("#btn-close").click(function () {
            a.resetChooseCustomerDom();
            $.closePopup("#popup_choose")
        })
    },
    handleRefresh: function () {
        var a = this, b = $("#popup_choose");
        b.find(".modal-content").pullToRefresh(function () {
            var c = this;
            setTimeout(function () {
                a.pager = {loading: false, lastPage: false, pageCount: 0, page: 1, rows: 15};
                a.customerList = [];
                a.resetChooseCustomerDom();
                a.initCustomerData(b);
                c.pullToRefreshDone()
            }, 1000)
        })
    },
    handleInfinite: function () {
        var a = this, b = $("#popup_choose");
        b.find(".modal-content").infinite(80).on("infinite", function () {
            var d = b.find(".searchInput");
            var c = $.trim(d.val());
            if (!a.pager.lastPage && c) {
                if (a.searchPager.loading) {
                    return
                }
                a.searchPager.loading = true;
                b.find(".msg-loading").show();
                a.initSearchCustomerData(b, c)
            } else {
                if (a.pager.loading) {
                    return
                }
                a.pager.loading = true;
                b.find(".msg-loading").show();
                a.initCustomerData(b)
            }
        })
    },
    handleSearchInput: function () {
        var a = this, b = $("#popup_choose");
        b.find(".searchInput").bind("input propertychange", function (h) {
            a.customerData = {};
            var c = [], g = a.customerList, d = $(this).val();
            b.find(".customer-list").empty();
            if (a.pager.lastPage) {
                for (var f in g) {
                    if (g[f].name.indexOf(d) >= 0) {
                        c.push(g[f])
                    }
                }
                a.createCustomerData(b, c)
            } else {
                if (d) {
                    a.searchPager = {loading: false, lastPage: false, pageCount: 0, page: 1, rows: 15};
                    a.initSearchCustomerData(b, d)
                } else {
                    a.createCustomerData(b, g)
                }
            }
        }).on("keydown", function (c) {
            if (c.keyCode == 13) {
                c.preventDefault()
            }
        })
    },
    handleSearchCancel: function () {
        var a = this, b = $("#popup_choose");
        b.on("click", ".searchCancel, .searchClear", function () {
            b.find(".customer-list").empty();
            a.createCustomerData(b, a.customerList)
        })
    },
    validateData: function () {
        var b = this, a = b.validateDataChange(), c = a.obj.mobile, f = b.customerData.id;
        if (f && a.isChange) {
            $.alert("信息被修改，无法保存！")
        } else {
            if (f) {
                b.ajaxData()
            } else {
                if (c) {
                    var e = /^(13[0-9]|14[579]|15[0-3,5-9]|16[6]|17[0135678]|18[0-9]|19[89])\d{8}$/i;
                    e = /^1\d{10}$/i;
                    if (e.test(c)) {
                        var d = [{field: "mobile", value: c, operator: "=", relation: "and"}, {
                            field: "corpid",
                            value: YT.getCorpId(),
                            operator: "=",
                            relation: "and"
                        }];
                        YT.query({
                            data: {m: b.m, t: "v_customers_distinct", filter: JSON.stringify(d)},
                            successCallback: function (g) {
                                if (200 == g.status) {
                                    if (g.object.length == 1) {
                                        $.alert("手机号已存在！")
                                    } else {
                                        b.ajaxData()
                                    }
                                }
                            }
                        })
                    } else {
                        $.alert("手机号格式不正确！")
                    }
                } else {
                    $.alert("手机号必须填写！")
                }
            }
        }
    },
    validateDataChange: function () {
        var m = this, f = m.getCustomerVal(), h = m.customerData, l = h.mobile, b = h.name || "", d = h.position || "",
            i = h.department || "", g = h.wechat || "", a = h.address || "", k = h.telephone || "", n = h.email || "",
            j = h.webSite || "", c = h.fax || "", e = h.remark || "";
        if (f.mobile == l && f.name == b && f.position == d && f.department == i && f.wechat == g && f.address == a && f.telephone == k && f.email == n && f.webSite == j && f.fax == c && f.remark == e) {
            return {obj: f, isChange: false}
        } else {
            return {obj: f, isChange: true}
        }
    },
    getCustomerVal: function () {
        var a = $("#mobile").val();
        var b = $.trim($("#name").val());
        var g = $.trim($("#position").val());
        var f = $.trim($("#department").val());
        var j = $.trim($("#wechat").val());
        var k = $.trim($("#address").val());
        var d = $("#telephone").val();
        var i = $.trim($("#email").val());
        var e = $.trim($("#webSite").val());
        var c = $.trim($("#fax").val());
        var h = $.trim($("#remark").val());
        return {
            mobile: a,
            name: b,
            position: g,
            department: f,
            wechat: j,
            address: k,
            telephone: d,
            email: i,
            webSite: e,
            fax: c,
            remark: h
        }
    },
    setCustomerVal: function (a) {
        var b = $.extend({
            mobile: "",
            name: "",
            position: "",
            department: "",
            wechat: "",
            address: "",
            telephone: "",
            email: "",
            webSite: "",
            fax: "",
            remark: ""
        }, a);
        $("#mobile").val(b.mobile);
        $("#name").val(b.name);
        $("#position").val(b.position);
        $("#department").val(b.department);
        $("#wechat").val(b.wechat);
        $("#address").val(b.address);
        $("#telephone").val(b.telephone);
        $("#email").val(b.email);
        $("#webSite").val(b.webSite);
        $("#fax").val(b.fax);
        $("#remark").val(b.remark)
    },
    resetCustomerDom: function () {
        $(document.body).removeClass("page-unScroll");
        $.closePopup()
    },
    resetChooseCustomerDom: function () {
        var a = $("#popup_choose");
        a.find(".searchInput").val("");
        a.find(".customer-list").empty();
        self.customerData = {}
    },
    resetCustomerData: function () {
        this.customerData = {};
        this.setCustomerVal()
    },
    ajaxData: function () {
        $.showLoading("数据提交中...");
        var b = this, a = [], e = b.getCustomerVal(), d = b.customerData.id;
        if (d) {
            var c = [{field: "id", value: d, operator: "=", relation: "AND"}];
            a.push({t: "customers", data: e, filter: c});
            YT.update({
                loading: false,
                data: {
                    m: b.m,
                    t: "customers",
                    v: JSON.stringify(a),
                    params: JSON.stringify({staff_id: b.staff_id, recordId: b.recordId, id: b.id})
                },
                successCallback: function (f) {
                    $.hideLoading();
                    if (200 == f.status) {
                        b.resetCustomerDom();
                        b.resetCustomerData();
                        $.alert("提交成功！", function () {
                            b.callback()
                        })
                    } else {
                        $.alert("提交失败！")
                    }
                }
            })
        } else {
            a.push({t: "customers", data: e, ai: true});
            YT.insert({
                loading: false,
                data: {
                    m: b.m,
                    t: "customers",
                    v: JSON.stringify(a),
                    params: JSON.stringify({staff_id: b.staff_id, recordId: b.recordId, id: b.id})
                },
                successCallback: function (f) {
                    $.hideLoading();
                    if (200 == f.status) {
                        b.resetCustomerDom();
                        b.resetCustomerData();
                        $.alert("提交成功！", function () {
                            b.callback()
                        })
                    } else {
                        $.alert("提交失败！")
                    }
                }
            })
        }
    },
    initCustomerData: function (b) {
        var a = this;
        YT.query({
            data: this.getPagerData(), successCallback: function (f) {
                if (200 == f.status) {
                    var c = f.object.items, d = b.find(".customer-list");
                    for (var e in c) {
                        a.customerList.push(c[e])
                    }
                    a.pager.page = f.object.idx + 1;
                    a.pager.pageCount = f.object.pageCount;
                    a.pager.lastPage = f.object.idx >= f.object.pageCount;
                    d.append(a.createCustomerHtml(c));
                    if (a.pager.lastPage) {
                        a.pager.loading = true;
                        b.find(".msg-loading").hide();
                        a.createMsgHtml(b, f.object.recordCount);
                        return
                    }
                }
                a.pager.loading = false
            }
        })
    },
    initSearchCustomerData: function (c, b) {
        var a = this;
        YT.query({
            data: this.getSearchPagerData(b), successCallback: function (f) {
                if (200 == f.status) {
                    var d = f.object.items, e = c.find(".customer-list");
                    a.searchPager.page = f.object.idx + 1;
                    a.searchPager.pageCount = f.object.pageCount;
                    a.searchPager.lastPage = f.object.idx >= f.object.pageCount;
                    e.append(a.createCustomerHtml(d));
                    if (a.searchPager.lastPage) {
                        a.searchPager.loading = true;
                        c.find(".msg-loading").hide();
                        a.createMsgHtml(c, f.object.recordCount);
                        return
                    }
                }
                a.searchPager.loading = false
            }
        })
    },
    createCustomerData: function (a, b) {
        a.find(".customer-list").append(this.createCustomerHtml(b));
        this.createMsgHtml(a, b.length)
    },
    getPagerData: function () {
        return {m: this.m, t: "v_customers_distinct", order: "id", page: this.pager.page, rows: this.pager.rows}
    },
    getSearchPagerData: function (a) {
        var b = [{field: "name", value: "%" + a + "%", operator: "like", relation: "and"}];
        return {
            m: this.m,
            t: "v_customers_distinct",
            filter: JSON.stringify(b),
            order: "id",
            page: this.searchPager.page,
            rows: this.searchPager.rows
        }
    },
    createFormHtml: function (e) {
        var d = "";
        for (var c in e) {
            var f = e[c], b = f.name, a = f.p_name;
            d += '<div class="weui-cell">';
            d += '<div class="weui-cell__hd"><label class="weui-label">' + b + "</label></div>";
            d += '<div class="weui-cell__bd">';
            d += '<input id="' + f.id + '" class="weui-input" type="' + f.type + '" placeholder="请输入' + b + '"';
            if (a) {
                d += " " + a + '="' + f.p_val + '"'
            }
            d += ">";
            d += "</div>";
            d += "</div>"
        }
        return d
    },
    createCustomerHtml: function (d) {
        var b = "";
        for (var a in d) {
            var c = d[a];
            b += '<label class="weui-cell weui-check__label">';
            b += '<div class="weui-cell__bd">';
            b += "<p>" + (c.name || "【未填姓名】") + "&nbsp;&nbsp;" + c.mobile + "</p>";
            b += "</div>";
            b += '<div class="weui-cell__ft">';
            b += '<input type="radio" name="radio" class="weui-check" data-d="' + JSON.stringify(c).replace(/"/g, "&quot;") + '">';
            b += '<span class="weui-icon-checked"></span>';
            b += "</div>";
            b += "</label>"
        }
        return b
    },
    createPopupHtml: function () {
        var a = "";
        a += '<div id="popup_customer" class="weui-popup__container">';
        a += '<div class="weui-popup__overlay"></div>';
        a += '<div class="weui-popup__modal">';
        a += '<div class="toolbar">';
        a += '<div class="toolbar-inner">';
        a += '<a href="javascript:;" class="picker-button close-popup_customer" style="position: relative;">关闭</a>';
        a += '<div class="picker-button">';
        a += '<a href="javascript:;" id="choose" style="margin-right: 20px;"><i class="iconfont" style="font-size: 20px;">&#xe640</i></a>';
        a += '<a href="javascript:;" id="toolbar-save">保存</a>';
        a += "</div>";
        a += '<h1 class="title">填写客户</h1>';
        a += "</div>";
        a += "</div>";
        a += '<div class="modal-content" style="-webkit-overflow-scrolling : touch;">';
        a += '<div class="weui-cells weui-cells_form" id="form_customer"></div>';
        a += '<div class="weui-cells__title">备注</div>';
        a += '<div class="weui-cells weui-cells_form">';
        a += '<div class="weui-cell">';
        a += '<div class="weui-cell__bd">';
        a += '<textarea id="remark" class="weui-textarea" placeholder="请输入备注" rows="3"></textarea>';
        a += "</div>";
        a += "</div>";
        a += "</div>";
        a += '<div style="position: relative;height: 80px;"></div>';
        a += "</div>";
        a += '<div style="position: fixed;bottom: 0;width: 100%;">';
        a += '<div class="weui-btn-area">';
        a += '<div class="weui-flex">';
        a += '<div class="weui-flex__item" style="margin-right: 15px;"><a class="weui-btn weui-btn_primary" id="save" href="javascript:;">保存</a></div>';
        a += '<div class="weui-flex__item"><a class="weui-btn weui-btn_default" id="btn-clear" href="javascript:;">重置</a></div>';
        a += '<a id="btn-save"></a>';
        a += "</div>";
        a += "</div>";
        a += "</div>";
        a += "</div>";
        a += "</div>";
        a += '<div id="popup_choose" class="weui-popup__container">';
        a += '<div class="weui-popup__overlay"></div>';
        a += '<div class="weui-popup__modal">';
        a += '<div class="modal-content" style="padding-top: 0;-webkit-overflow-scrolling : touch;">';
        a += '<div class="weui-pull-to-refresh__layer">';
        a += '<div class="weui-pull-to-refresh__arrow"></div>';
        a += '<div class="weui-pull-to-refresh__preloader"></div>';
        a += '<div class="down">下拉刷新</div>';
        a += '<div class="up">释放刷新</div>';
        a += '<div class="refresh">正在刷新</div>';
        a += "</div>";
        a += '<div class="weui-search-bar">';
        a += '<form class="weui-search-bar__form">';
        a += '<div class="weui-search-bar__box">';
        a += '<i class="weui-icon-search"></i>';
        a += '<input type="search" class="weui-search-bar__input searchInput" placeholder="搜索" required="">';
        a += '<a href="javascript:" class="weui-icon-clear searchClear"></a>';
        a += "</div>";
        a += '<label class="weui-search-bar__label searchText">';
        a += '<i class="weui-icon-search"></i>';
        a += "<span>搜索</span>";
        a += "</label>";
        a += "</form>";
        a += '<a href="javascript:" class="weui-search-bar__cancel-btn searchCancel">取消</a>';
        a += "</div>";
        a += '<div class="weui-panel weui-panel_access">';
        a += '<div class="weui-panel__bd  weui-cells_checkbox customer-list"></div>';
        a += "</div>";
        a += '<div class="weui-loadmore msg-loading">';
        a += '<i class="weui-loading"></i>';
        a += '<span class="weui-loadmore__tips">正在加载</span>';
        a += "</div>";
        a += "</div>";
        a += '<div style="position: fixed;bottom: 0;width: 100%;">';
        a += '<div class="weui-btn-area">';
        a += '<div class="weui-flex">';
        a += '<div class="weui-flex__item" style="margin-right: 15px;"><a class="weui-btn weui-btn_primary close-popup_choose" href="javascript:;">保存</a></div>';
        a += '<div class="weui-flex__item"><a class="weui-btn weui-btn_default" id="btn-close" href="javascript:;">关闭</a></div>';
        a += '<a id="btn-save"></a>';
        a += "</div>";
        a += "</div>";
        a += "</div>";
        a += "</div>";
        a += "</div>";
        $(document.body).append(a)
    },
    createMsgHtml: function (a, b) {
        a.find(".msg-content").remove();
        a.find(".weui-panel_access").after('<div class="weui-loadmore weui-loadmore_line msg-content"><span class="weui-loadmore__tips">共' + b + "条数据</span></div>")
    }
};